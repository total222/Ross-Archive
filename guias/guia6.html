<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guía: Conectar Base de Datos con Google Cloud Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .guide-container h2 {
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-top: 2.5rem;
            margin-bottom: 1.5rem;
        }
        .code-block {
            background-color: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            color: #d1d5db;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .info-box {
            background-color: #eef2ff;
            border-left: 4px solid #4f46e5;
            padding: 1rem;
        }
        .success-box {
            background-color: #f0fdf4;
            border-left: 4px solid #22c55e;
            padding: 1rem;
        }
        .step-number {
            background-color: #4f46e5;
            color: white;
            border-radius: 9999px;
            width: 2.5rem;
            height: 2.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.25rem;
            margin-right: 1rem;
        }
        .flex-heading {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto max-w-4xl px-4 py-12">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-indigo-700">El Puente entre tu Base de Datos y tu Bucket</h1>
            <p class="mt-4 text-lg text-gray-600">
                Aprende el flujo de trabajo para relacionar los registros de tu base de datos con los archivos privados que almacenas en Google Cloud Storage.
            </p>
        </header>

        <main class="bg-white p-6 sm:p-10 rounded-lg shadow-lg guide-container">

            <div class="info-box">
                <p class="font-bold">El Concepto Clave: El Vínculo</p>
                <p class="mt-2">Tu base de datos NUNCA guardará la imagen, el PDF o el video. En su lugar, guardarás una simple cadena de texto: el <b class="font-semibold">nombre único del objeto (archivo)</b> dentro de tu bucket. Este nombre es el "vínculo" o la "llave foránea" que conecta el registro de la DB con el archivo real.</p>
            </div>
            

            <h2 class="text-2xl font-bold text-gray-800 flex-heading">
                <span class="step-number">1</span>Flujo 1: Subir un archivo y guardar la referencia
            </h2>
            <div class="step mt-4 text-gray-700 space-y-4">
                <p>Este es el proceso cuando un usuario sube un nuevo contenido (por ejemplo, un post con una imagen).</p>
                <ol class="list-decimal list-inside space-y-4 pl-4">
                    <li>
                        <b class="font-semibold">Recepción de Datos:</b> Tu backend recibe los datos del formulario (ej. `titulo`, `descripcion`) y el archivo (`imagen.jpg`).
                    </li>
                    <li>
                        <b class="font-semibold">Generar un Nombre Único (¡CRÍTICO!):</b> Nunca guardes el archivo con su nombre original. ¿Qué pasa si dos usuarios suben un archivo llamado `foto.png`? Para evitar colisiones, genera un nombre único. Una excelente estrategia es usar un UUID (Identificador Único Universal).
                    </li>
                    <li>
                        <b class="font-semibold">Subida al Bucket:</b> Usas la librería de Google Cloud para subir el archivo a tu bucket, pero con el <b class="font-semibold">nuevo nombre único</b>. Por ejemplo: `a1b2c3d4-e5f6-4a5b-8c9d-0e1f2a3b4c5d.jpg`.
                    </li>
                    <li>
                        <b class="font-semibold">Guardado en la Base de Datos:</b> <b class="font-semibold">Solo si la subida al bucket fue exitosa</b>, procedes a guardar la información en tu base de datos. Creas un nuevo registro en tu tabla con el `titulo`, la `descripcion` y, lo más importante, el `nombre_unico_del_archivo` que generaste.
                    </li>
                </ol>
                <p class="font-semibold mt-6">Ejemplo de Estructura de Tabla en SQL:</p>
                <div class="code-block">
                    CREATE TABLE Contenido (
                        id INT PRIMARY KEY AUTO_INCREMENT,
                        titulo VARCHAR(255) NOT NULL,
                        descripcion TEXT,
                        -- Esta columna es el "puente" hacia el bucket
                        nombre_archivo_bucket VARCHAR(255) NOT NULL, 
                        fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                    );
                </div>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 flex-heading">
                <span class="step-number">2</span>Flujo 2: Extraer y mostrar un archivo relacionado
            </h2>
            <div class="step mt-4 text-gray-700 space-y-4">
                <p>Ahora, el proceso inverso: un usuario quiere ver el contenido que subió.</p>
                <ol class="list-decimal list-inside space-y-4 pl-4">
                    <li>
                        <b class="font-semibold">Solicitud del Cliente:</b> El navegador solicita una página, por ejemplo, `https://misitio.com/contenido/123`.
                    </li>
                    <li>
                        <b class="font-semibold">Consulta a la Base de Datos:</b> Tu backend toma el ID `123` y hace una consulta a la base de datos para obtener los detalles de ese contenido.
                        <div class="code-block mt-2">SELECT titulo, descripcion, nombre_archivo_bucket FROM Contenido WHERE id = 123;</div>
                    </li>
                    <li>
                        <b class="font-semibold">Obtención del Nombre del Archivo:</b> La base de datos te devuelve el título, la descripción y el nombre del archivo: `a1b2c3d4-e5f6-4a5b-8c9d-0e1f2a3b4c5d.jpg`.
                    </li>
                    <li>
                        <b class="font-semibold">Generar una URL Firmada (Signed URL):</b> Aquí está la magia. Tus archivos en el bucket son privados. Para que el usuario pueda verlos, no le das un enlace directo. En su lugar, le pides a la API de Google Cloud que genere una <b class="font-semibold">URL temporal y segura</b> que da acceso de solo lectura a ESE archivo específico por un corto periodo de tiempo (ej. 5 minutos).
                    </li>
                     <li>
                        <b class="font-semibold">Renderizar la Página:</b> Tu backend envía al frontend toda la información: el título, la descripción y la `url_firmada` que acabas de generar. El frontend usa esa URL en el atributo `src` de una etiqueta `<img>` o en el `href` de un enlace de descarga.
                    </li>
                </ol>

                <div class="success-box mt-4">
                    <p class="font-bold">¡El Resultado!</p>
                    <p class="mt-2">El usuario ve la imagen en su navegador. El navegador la cargó usando la URL segura y temporal, pero el archivo en tu bucket <b class="font-semibold">nunca se hizo público</b>. Cuando la URL expire, ya no funcionará, manteniendo tus archivos seguros.</p>
                </div>
                 <p class="font-semibold mt-6">Ejemplo de código Backend (Node.js) para generar la URL firmada:</p>
                 <div class="code-block">
                    // Asumiendo que ya tienes configurado el cliente de Storage
                    // y 'nombreArchivoBucket' viene de tu consulta a la DB
                    
                    async function generateSignedUrl(nombreArchivoBucket) {
                      const options = {
                        version: 'v4',
                        action: 'read',
                        expires: Date.now() + 15 * 60 * 1000, // 15 minutos de validez
                      };

                      // Genera la URL para el archivo específico
                      const [url] = await storage
                        .bucket('nombre-de-tu-bucket')
                        .file(nombreArchivoBucket)
                        .getSignedUrl(options);
                      
                      console.log(`URL generada: ${url}`);
                      return url;
                    }
                 </div>
            </div>
        </main>
    </div>

</body>
</html>

